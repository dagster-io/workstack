# REQUIRED REPOSITORY SETTING:
# Settings > Actions > General > Workflow permissions
# âœ“ Enable "Allow GitHub Actions to create and approve pull requests"
#
# Without this setting, PR creation will fail with:
# "GitHub Actions is not permitted to create or approve pull requests"

name: Implement Plan

on:
  workflow_dispatch:
    inputs:
      branch-name:
        description: 'Branch name to implement'
        required: true
  push:
    branches:
      - '**'
    paths:
      - '.submission/**'

jobs:
  implement:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name || github.ref }}
          token: ${{ github.token }}

      - name: Check for submission
        id: check_submission
        run: |
          if [ -d ".submission" ]; then
            echo "has_submission=true" >> $GITHUB_OUTPUT
          else
            echo "has_submission=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup environment
        if: steps.check_submission.outputs.has_submission == 'true'
        run: |
          # Install uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env

          # Install erk
          cd $GITHUB_WORKSPACE
          uv tool install --from . erk

          # Install dot-agent from local package
          uv tool install --from ./packages/dot-agent-kit dot-agent-kit

          # Install Claude Code
          npm install -g @anthropic-ai/claude-code

          # Install Prettier
          npm install -g prettier

          # Install erk kit for Claude Code
          dot-agent kit install erk

      - name: Configure git
        if: steps.check_submission.outputs.has_submission == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Copy submission to plan
        if: steps.check_submission.outputs.has_submission == 'true'
        run: |
          # Copy .submission/ to .plan/ for implementation
          cp -r .submission .plan
          echo "Copied .submission/ to .plan/"

      - name: Run implementation with CI loop
        if: steps.check_submission.outputs.has_submission == 'true'
        run: |
          claude --print \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:implement-plan"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push implementation changes
        if: steps.check_submission.outputs.has_submission == 'true'
        run: |
          # Check if there are any changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            echo "Changes detected, committing and pushing to branch..."
            git add .
            git commit -m "Implement plan changes via AI"
            git push origin ${{ github.ref_name }}
          else
            echo "No changes to push"
          fi

      - name: Trigger CI workflows
        if: steps.check_submission.outputs.has_submission == 'true'
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "Triggering CI workflows for branch: $BRANCH"

          # Trigger each CI workflow explicitly
          gh workflow run test.yml --ref "$BRANCH"
          gh workflow run lint.yml --ref "$BRANCH"
          gh workflow run pyright.yml --ref "$BRANCH"
          gh workflow run prettier.yml --ref "$BRANCH"
          gh workflow run check-sync.yml --ref "$BRANCH"
          gh workflow run md-check.yml --ref "$BRANCH"

          echo "All CI workflows triggered"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup submission folder
        id: cleanup
        if: steps.check_submission.outputs.has_submission == 'true'
        run: |
          # Delete .submission/ folder after successful implementation
          rm -rf .submission

          # Commit the deletion if changes exist
          if [[ -n $(git status --porcelain) ]]; then
            git add .submission
            git commit -m "Remove .submission/ after implementation"
            git push origin ${{ github.ref_name }}
            echo "Deleted .submission/ folder"
          fi

      - name: Create or update pull request
        if: steps.cleanup.conclusion == 'success'
        run: |
          set -e

          # Check if PR already exists for this branch
          if gh pr view "${{ github.ref_name }}" --json number &> /dev/null; then
            echo "âœ“ PR already exists for branch ${{ github.ref_name }}"
            echo "  (git push already updated it)"
            exit 0
          fi

          # Format branch name for PR title
          # Example: feat-awesome-feature â†’ Feat awesome feature
          BRANCH_NAME="${{ github.ref_name }}"
          PR_TITLE=$(echo "$BRANCH_NAME" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/')

          # Generate PR body
          PR_BODY=$(cat <<'EOF'
          ## Implementation Details

          This PR was automatically generated by ERK's AI implementation workflow.

          ### Plan Reference
          - Implementation plan: See `.plan/plan.md` in this branch
          - GitHub Actions run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Testing Checklist

          - [ ] Review AI-generated code changes
          - [ ] Run unit tests locally: `uv run pytest tests/unit/`
          - [ ] Run integration tests: `uv run pytest tests/integration/`
          - [ ] Verify type checking: `uv run pyright`
          - [ ] Test command functionality manually
          - [ ] Review security implications

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          EOF
          )

          # Create PR (gh will use repository default branch as base)
          gh pr create \
            --head "${{ github.ref_name }}" \
            --title "$PR_TITLE" \
            --body "$PR_BODY"

          echo "âœ“ Created PR: $PR_TITLE"
        env:
          GH_TOKEN: ${{ github.token }}
