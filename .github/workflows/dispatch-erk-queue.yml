# REQUIRED REPOSITORY SETTING:
# Settings > Actions > General > Workflow permissions
# âœ“ Enable "Allow GitHub Actions to create and approve pull requests"
#
# Without this setting, PR creation will fail with:
# "GitHub Actions is not permitted to create or approve pull requests"

name: Dispatch Erk Queue

on:
  issues:
    types: [opened, labeled]

concurrency:
  group: implement-issue-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  implement:
    if: contains(github.event.issue.labels.*.name, 'erk-queue')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      - name: Setup environment for workflow started comment
        run: |
          # Install uv (needed for dot-agent)
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env

          # Install dot-agent from local package
          cd $GITHUB_WORKSPACE
          uv tool install --from ./packages/dot-agent-kit dot-agent-kit

      - name: Post workflow started comment
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          WORKFLOW_RUN_ID: ${{ github.run_id }}
          SERVER_URL: ${{ github.server_url }}
          REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: |
          source $HOME/.cargo/env
          WORKFLOW_RUN_URL="$SERVER_URL/$REPOSITORY/actions/runs/$WORKFLOW_RUN_ID"

          dot-agent run erk post-workflow-started-comment \
            --issue-number "$ISSUE_NUMBER" \
            --workflow-run-id "$WORKFLOW_RUN_ID" \
            --workflow-run-url "$WORKFLOW_RUN_URL" \
            2>/dev/null || true

      - name: Derive branch name from issue title
        id: branch_name
        # SECURITY: Use env block to prevent code injection attacks
        # Issue titles are user-controlled and could contain malicious code like `curl attacker.com`
        # Direct interpolation (${{ github.event.issue.title }}) in shell would execute as code
        # Environment variables treat the input as data, not code
        # See: https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#understanding-the-risk-of-script-injections
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Convert issue title to kebab-case
          # ISSUE_TITLE is now safely in environment, not interpolated in shell
          BRANCH_NAME=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')

          # Truncate to 30 characters for git worktree compatibility
          BRANCH_NAME="${BRANCH_NAME:0:30}"

          # Ensure no trailing hyphens after truncation
          BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/-$//')

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Derived branch name: $BRANCH_NAME"

      - name: Create and switch to branch
        # SECURITY: Use env block for consistency
        # BRANCH_NAME is derived from sanitized user input (see branch derivation step)
        # Using env block maintains security best practices throughout workflow
        env:
          BRANCH_NAME: ${{ steps.branch_name.outputs.branch_name }}
        run: |
          git checkout -b "$BRANCH_NAME"

      - name: Setup environment
        run: |
          # Install uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env

          # Install erk
          cd $GITHUB_WORKSPACE
          uv tool install --from . erk

          # Install dot-agent from local package
          uv tool install --from ./packages/dot-agent-kit dot-agent-kit

          # Install Claude Code
          npm install -g @anthropic-ai/claude-code

          # Install Prettier
          npm install -g prettier

          # Install erk kit for Claude Code
          dot-agent kit install erk

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create plan folder
        # SECURITY: Use env block to prevent code injection attacks
        # Issue bodies are user-controlled and could contain:
        #   1. Heredoc terminators (EOF) to break out of cat command
        #   2. Command substitution syntax ($() or ``)
        #   3. Script injection payloads
        # Using printf with environment variable prevents interpretation as code
        # See: https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#understanding-the-risk-of-script-injections
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
        run: |
          mkdir -p .impl

          # Save issue body as plan.md using printf for safety
          # This prevents heredoc injection attacks
          printf '%s\n' "$ISSUE_BODY" > .impl/plan.md

          # Create issue.json reference using environment variables
          cat > .impl/issue.json <<EOF
          {
            "issue_number": $ISSUE_NUMBER,
            "issue_url": "$ISSUE_URL",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "synced_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          # Extract steps from plan.md and create progress.md with frontmatter
          # This uses a simple regex to find numbered steps
          STEP_COUNT=$(grep -E '^\s*[0-9]+\.' .impl/plan.md | wc -l | tr -d ' ')

          cat > .impl/progress.md <<EOF
          ---
          completed_steps: 0
          total_steps: $STEP_COUNT
          ---

          # Progress Tracking

          EOF

          # Extract steps and create checkboxes
          grep -E '^\s*[0-9]+\.' .impl/plan.md | sed 's/^\s*//' | sed 's/^/- [ ] /' >> .impl/progress.md

          echo "Created .impl/ folder structure"

      - name: Run implementation
        id: implement
        run: |
          set +e  # Don't exit on error

          claude --print \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:implement-plan"

          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "implementation_success=true" >> $GITHUB_OUTPUT
          else
            echo "implementation_success=false" >> $GITHUB_OUTPUT
          fi

          exit 0  # Don't fail the workflow
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}

      - name: Commit and push changes
        id: commit
        # SECURITY: Use env block for consistency and safety
        # While ISSUE_NUMBER is not user-controlled, using env block maintains consistent pattern
        # and prevents accidental introduction of vulnerabilities in future edits
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          BRANCH_NAME: ${{ steps.branch_name.outputs.branch_name }}
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "Implement plan from issue #$ISSUE_NUMBER"
            git push origin "$BRANCH_NAME"
            echo "âœ“ Changes committed and pushed"
            echo "changes_pushed=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit"
            echo "changes_pushed=false" >> $GITHUB_OUTPUT
          fi

      # Token Permissions:
      # Uses github.token (not secrets.GITHUB_TOKEN) to match the working pattern in implement-plan.yml
      # Requires repository setting: Settings > Actions > General > "Allow GitHub Actions to create and approve pull requests"
      # If this step fails with "not permitted" error, check:
      # 1. Repository settings (above)
      # 2. Organization settings (if in an org)
      # 3. Enterprise settings (if applicable)
      - name: Create pull request
        if: steps.commit.outputs.changes_pushed == 'true'
        # SECURITY: Use env block to prevent code injection attacks
        # User-controlled inputs (issue title, issue body) must not be directly interpolated
        # Direct interpolation like PR_TITLE="${{ github.event.issue.title }}" would allow:
        #   - Command injection via backticks or $()
        #   - Quote escaping to run arbitrary commands
        #   - Token exfiltration via curl/wget
        # Environment variables ensure untrusted input is treated as data, not executable code
        # See: https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#understanding-the-risk-of-script-injections
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          BRANCH_NAME: ${{ steps.branch_name.outputs.branch_name }}
          IMPLEMENTATION_SUCCESS: ${{ steps.implement.outputs.implementation_success }}
          SERVER_URL: ${{ github.server_url }}
          REPOSITORY: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if PR already exists
          if gh pr view "$BRANCH_NAME" --json number &> /dev/null; then
            echo "âœ“ PR already exists for branch $BRANCH_NAME"
            exit 0
          fi

          # Create PR body based on implementation success using environment variables
          if [ "$IMPLEMENTATION_SUCCESS" = "true" ]; then
            cat > pr_body.md <<EOF
          ## Implementation Complete

          This PR implements the plan from issue #$ISSUE_NUMBER.

          **Implementation Details:**
          - Plan source: #$ISSUE_NUMBER
          - GitHub Actions run: $SERVER_URL/$REPOSITORY/actions/runs/$RUN_ID

          ### Testing Checklist
          - [ ] Review AI-generated code changes
          - [ ] Run unit tests locally
          - [ ] Run integration tests
          - [ ] Verify type checking
          - [ ] Test command functionality manually

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          EOF
          else
            cat > pr_body.md <<EOF
          ## Implementation Failed

          This PR contains partial implementation from issue #$ISSUE_NUMBER.

          **âš ï¸ Implementation encountered errors** - Review the [workflow run]($SERVER_URL/$REPOSITORY/actions/runs/$RUN_ID) for details.

          ### Next Steps
          - Review implementation errors
          - Fix issues manually or re-trigger workflow
          - Run tests and type checking

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          EOF
          fi

          gh pr create --head "$BRANCH_NAME" --title "$ISSUE_TITLE" --body-file pr_body.md
          echo "âœ“ Created PR: $ISSUE_TITLE"

      - name: Trigger CI workflows
        if: steps.commit.outputs.changes_pushed == 'true'
        # SECURITY: Use env block for consistency
        # BRANCH_NAME is derived from sanitized user input (see branch derivation step)
        # Using env block maintains security best practices throughout workflow
        env:
          BRANCH_NAME: ${{ steps.branch_name.outputs.branch_name }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Triggering CI workflows for branch: $BRANCH_NAME"

          gh workflow run test.yml --ref "$BRANCH_NAME"
          gh workflow run lint.yml --ref "$BRANCH_NAME"
          gh workflow run pyright.yml --ref "$BRANCH_NAME"
          gh workflow run prettier.yml --ref "$BRANCH_NAME"
          gh workflow run check-sync.yml --ref "$BRANCH_NAME"
          gh workflow run md-check.yml --ref "$BRANCH_NAME"

          echo "âœ“ All CI workflows triggered"
