# REQUIRED REPOSITORY SETTING:
# Settings > Actions > General > Workflow permissions
# âœ“ Enable "Allow GitHub Actions to create and approve pull requests"
#
# Without this setting, PR creation will fail with:
# "GitHub Actions is not permitted to create or approve pull requests"

name: Implement Plan

on:
  workflow_dispatch:
    inputs:
      branch-name:
        description: "Branch name to implement"
        required: true
  push:
    branches:
      - "**"
    paths:
      - ".worker-impl/**"

jobs:
  implement:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name || github.ref }}
          token: ${{ github.token }}

      - name: Check for worker implementation
        id: check_submission
        run: |
          if [ -d ".worker-impl" ]; then
            echo "has_worker_impl=true" >> $GITHUB_OUTPUT
          else
            echo "has_worker_impl=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup environment
        if: steps.check_submission.outputs.has_worker_impl == 'true'
        run: |
          # Install uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env

          cd $GITHUB_WORKSPACE

          # Install workspace packages in dependency order (bottom-up)
          # Step 1: Install erk-shared first (no workspace dependencies)
          uv tool install --from ./packages/erk-shared erk-shared

          # Step 2: Install dot-agent-kit (depends on erk-shared)
          uv tool install --from ./packages/dot-agent-kit --with ./packages/erk-shared dot-agent-kit

          # Step 3: Install erk (depends on erk-shared and dot-agent-kit)
          uv tool install --from . --with ./packages/erk-shared --with ./packages/dot-agent-kit erk

          # Install Claude Code
          npm install -g @anthropic-ai/claude-code

          # Install Prettier
          npm install -g prettier

          # Install erk kit for Claude Code
          dot-agent kit install erk

      - name: Configure git
        if: steps.check_submission.outputs.has_worker_impl == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Copy worker implementation to plan
        if: steps.check_submission.outputs.has_worker_impl == 'true'
        run: |
          # Copy .worker-impl/ to .impl/ for implementation
          cp -r .worker-impl .impl
          echo "Copied .worker-impl/ to .impl/"

      - name: Run implementation with CI loop
        if: steps.check_submission.outputs.has_worker_impl == 'true'
        run: |
          claude --print \
            --output-format stream-json \
            --dangerously-skip-permissions \
            --verbose \
            "/erk:implement-plan"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push implementation changes
        if: steps.check_submission.outputs.has_submission == 'true'
        run: |
          # Check if there are any changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            echo "Changes detected, committing and pushing to branch..."
            git add .
            git commit -m "Implement plan changes via AI"
            git push origin ${{ github.ref_name }}
          else
            echo "No changes to push"
          fi

      - name: Cleanup worker implementation folder
        id: cleanup
        if: steps.check_submission.outputs.has_worker_impl == 'true'
        run: |
          # Delete .worker-impl/ folder after successful implementation
          rm -rf .worker-impl

          # Commit the deletion if changes exist
          if [[ -n $(git status --porcelain) ]]; then
            git add .worker-impl
            git commit -m "Remove .worker-impl/ after implementation"
            git push origin ${{ github.ref_name }}
            echo "Deleted .worker-impl/ folder"
          fi

      - name: Create or update pull request
        if: steps.cleanup.conclusion == 'success'
        run: |
          set -e

          # Check if PR already exists for this branch
          if gh pr view "${{ github.ref_name }}" --json number &> /dev/null; then
            echo "âœ“ PR already exists for branch ${{ github.ref_name }}"
            echo "  (git push already updated it)"
            exit 0
          fi

          # Format branch name for PR title
          # Example: feat-awesome-feature â†’ Feat awesome feature
          BRANCH_NAME="${{ github.ref_name }}"
          PR_TITLE=$(echo "$BRANCH_NAME" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/')

          # Generate PR body
          PR_BODY=$(cat <<'EOF'
          ## Implementation Details

          This PR was automatically generated by ERK's AI implementation workflow.

          ### Plan Reference
          - Implementation plan: See `.impl/plan.md` in this branch
          - GitHub Actions run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Testing Checklist

          - [ ] Review AI-generated code changes
          - [ ] Run unit tests locally: `uv run pytest tests/unit/`
          - [ ] Run integration tests: `uv run pytest tests/integration/`
          - [ ] Verify type checking: `uv run pyright`
          - [ ] Test command functionality manually
          - [ ] Review security implications

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          EOF
          )

          # Create PR (gh will use repository default branch as base)
          gh pr create \
            --head "${{ github.ref_name }}" \
            --title "$PR_TITLE" \
            --body "$PR_BODY"

          echo "âœ“ Created PR: $PR_TITLE"
        env:
          GH_TOKEN: ${{ github.token }}
