# Plan: Agent-Facing Documentation for Plan Lifecycle

## Overview

Create comprehensive agent-facing documentation explaining the full lifecycle of a plan from creation through submission, dispatch, implementation, and merging. This documentation will help agents understand the state machine, entity relationships, and how to reconstruct context at any point in the workflow.

## Documentation Location

Create a new file: `docs/agent/plan-lifecycle.md`

## Documentation Structure

### 1. Executive Summary

- One-page overview of the entire lifecycle
- Quick reference for which phase the user is in based on observable state
- Key file locations at a glance

### 2. Phase 1: Plan Creation

Document the two creation paths:

- **Interactive**: `/erk:craft-plan` → Plan Mode → `~/.claude/plans/` → GitHub Issue
- **CLI**: `erk plan create --file <path>` → GitHub Issue directly

Key details:

- Plan storage in `~/.claude/plans/*.md` (sorted by modification time)
- Schema v2: metadata in issue body (`plan-header`), content in first comment (`plan-body`)
- The `erk-plan` label marks issues as implementation plans
- Label is auto-created (green, #0E8A16) if it doesn't exist

### 3. Phase 2: Plan Submission

Document `erk submit <issue_number>`:

- **Validation**: Must have `erk-plan` label, must be OPEN, clean working directory
- **Branch creation**: Derived from issue title using `derive_branch_name_with_date()`
- **`.worker-impl/` folder**: Created with plan.md, issue.json, progress.md, README.md
- **Draft PR creation**: Done locally before dispatch (avoids GitHub Actions permission issues)
- **distinct_id generation**: 6-char base36 for workflow run discovery
- **Metadata**: `submission-queued` block added to issue comment

### 4. Phase 3: Workflow Dispatch

Document `dispatch-erk-queue-git.yml`:

- **Inputs**: issue_number, submitted_by, distinct_id, issue_title
- **Concurrency**: group by issue number, cancel-in-progress
- **5 Phases**:
  1. Checkout & Setup (install tools, configure git)
  2. Branch Setup (derive name, create/reuse branch, create `.worker-impl/`)
  3. PR Setup (create draft PR, post workflow-started comment, update dispatch info)
  4. Implementation (copy to `.impl/`, run `/erk:plan-implement`)
  5. Submission (stage, `/git:pr-push`, cleanup `.worker-impl/`, mark PR ready)

### 5. Phase 4: Implementation

Document the implementation execution:

- **`.worker-impl/` → `.impl/`**: Copied for Claude Code to read
- **`.impl/run-info.json`**: Contains run_id and run_url
- **`/erk:plan-implement`**: Slash command that executes the plan
- **Progress tracking**: Via `progress.md` checkboxes

### 6. Phase 5: PR Finalization & Merge

Document the final steps:

- **`/git:pr-push`**: Pure git submission with AI-generated commit message
- **`.worker-impl/` cleanup**: Removed in separate commit (never in final PR)
- **PR marked ready**: `gh pr ready`
- **PR body updated**: Implementation summary + `get-pr-metadata` footer
- **CI trigger**: Empty commit to trigger push event workflows
- **Auto-close**: "Closes #X" in PR body auto-closes issue on merge

### 7. State Linking Mechanisms

Document how entities are connected:

#### Branch → Issue

- Deterministic naming via `derive_branch_name_with_date(issue_title)`
- Format: `{slugified-title-30chars}-YY-MM-DD-HHMM`

#### PR → Issue

- "Closes #{issue_number}" in PR body
- GitHub automatically closes issue on merge
- Generated by `get_closing_text()` from `.impl/issue.json`

#### Issue → Workflow Run

- `last_dispatched_run_id` in `plan-header` metadata block
- Updated by `update-dispatch-info` kit CLI command

#### Workflow Run → Issue

- `issue_number` passed as workflow input
- Available in `${{ inputs.issue_number }}`

#### Run Discovery

- `distinct_id` (6-char base36) generated at dispatch time
- Workflow `run-name` set to `"{issue_number}:{distinct_id}"`
- Polling matches runs by displayTitle containing `:distinct_id`

### 8. Metadata Block Reference

Document all metadata block types:

| Block Key                   | Location            | Purpose                                         |
| --------------------------- | ------------------- | ----------------------------------------------- |
| `plan-header`               | Issue body          | Plan metadata (created_at, dispatched_at, etc.) |
| `plan-body`                 | Issue first comment | Full plan content in collapsible details        |
| `submission-queued`         | Issue comment       | Marks submission to queue                       |
| `workflow-started`          | Issue comment       | Links to specific workflow run                  |
| `erk-implementation-status` | Issue comment       | Progress updates during implementation          |

Include the block format:

````html
<!-- erk:metadata-block:{key} -->
<details>
  <summary><code>{key}</code></summary>

  ```yaml {structured_data}
</details>
````
