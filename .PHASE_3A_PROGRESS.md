# Phase 3a Progress: Deploy WorkstackContext Factories

**Status**: PARTIALLY COMPLETE (need to continue in fresh session)

## What Was Completed

### ✅ Step 1: Fixed Imports (33 files)

Successfully removed broken `from tests.fakes.global_config_ops import FakeGlobalConfigOps` imports and added `from workstack.core.global_config import GlobalConfig` imports.

**Files with fixed imports:**
- ✅ tests/core/foundation/test_context.py (FULLY COMPLETE - tests passing)
- ✅ tests/test_utils/builders.py (FULLY COMPLETE - updated build() method)
- ✅ tests/unit/fakes/test_fake_global_config_ops.py (DELETED - obsolete)
- ✅ All 5 workspace command tests (imports fixed)
- ✅ All 5 navigation command tests (imports fixed)
- ✅ All 6 display command tests (imports fixed)
- ✅ All 7 other command tests (imports fixed)
- ✅ All 6 unit/integration tests (imports fixed)

### ✅ Step 2: Updated Core Files

**Fully updated files (usages replaced):**
1. `tests/core/foundation/test_context.py` - All 2 tests updated to use `.for_test()` factory
2. `tests/test_utils/builders.py` - `WorktreeScenario.build()` updated to use `GlobalConfig` and `.for_test()`

## What Remains

### ❌ Step 3: Replace FakeGlobalConfigOps Usages (249 occurrences across 29 files)

The import statements were removed, but the **usages** of `FakeGlobalConfigOps` still exist in test code. These need to be replaced with:

1. Create `GlobalConfig` instance instead of `FakeGlobalConfigOps`
2. Update `WorkstackContext(...)` constructions to use `.for_test()` or `.minimal()` factory methods

**Pattern to apply:**

```python
# BEFORE
global_config_ops = FakeGlobalConfigOps(
    workstacks_root=Path("/some/path"),
    use_graphite=True,
)
test_ctx = WorkstackContext(
    git_ops=git_ops,
    global_config_ops=global_config_ops,
    github_ops=FakeGitHubOps(),
    graphite_ops=FakeGraphiteOps(),
    shell_ops=FakeShellOps(),
    cwd=cwd,
    dry_run=False,
)

# AFTER
global_config = GlobalConfig(
    workstacks_root=Path("/some/path"),
    use_graphite=True,
    shell_setup_complete=False,
    show_pr_info=True,
    show_pr_checks=False,
)
test_ctx = WorkstackContext.for_test(
    git_ops=git_ops,
    global_config=global_config,
    cwd=cwd,
)
```

### Files Still Needing Usage Updates (29 files, 249 occurrences)

**Workspace commands (5 files):**
- tests/commands/workspace/test_create.py
- tests/commands/workspace/test_rm.py
- tests/commands/workspace/test_rename.py
- tests/commands/workspace/test_move.py
- tests/commands/workspace/test_consolidate.py

**Navigation commands (5 files):**
- tests/commands/navigation/test_up.py
- tests/commands/navigation/test_switch_up_down.py
- tests/commands/navigation/test_jump.py
- tests/commands/navigation/test_graphite_find_worktrees.py
- tests/commands/navigation/test_down.py

**Display commands (6 files):**
- tests/commands/display/test_tree.py
- tests/commands/display/list/test_trunk_detection.py
- tests/commands/display/list/test_stacks.py
- tests/commands/display/list/test_root_filtering.py
- tests/commands/display/list/test_pr_info.py
- tests/commands/display/list/test_basic.py

**Other command tests (7 files):**
- tests/commands/graphite/test_land_stack.py
- tests/commands/graphite/test_gt_branches.py
- tests/commands/sync/test_sync.py
- tests/commands/test_status_with_fakes.py
- tests/commands/setup/test_init.py
- tests/commands/setup/test_config.py
- tests/commands/shell/test_prepare_cwd_recovery.py

**Unit/integration tests (6 files):**
- tests/unit/status/test_graphite_stack_collector.py
- tests/unit/status/test_github_pr_collector.py
- tests/unit/detection/test_trunk_detection.py
- tests/integration/test_real_global_config.py
- tests/integration/test_land_stack_worktree.py
- tests/integration/test_dryrun_integration.py

## How to Continue

When resuming in a fresh session:

1. **Read this progress file** to understand current state
2. **Pick one file** from the list above (suggest starting with workspace tests)
3. **For each occurrence of `FakeGlobalConfigOps` in that file:**
   - Replace with `GlobalConfig(...)` with all 5 required fields
   - Update `WorkstackContext(...)` to use `.for_test(...)` factory
4. **Test the file** with `uv run pytest <file>` to ensure it works
5. **Repeat** for remaining files
6. **Run `/ensure-ci`** when all files are fixed
7. **Commit** with message: "Refactor tests to use WorkstackContext factory methods"

## Quick Stats

- ✅ **Imports fixed**: 33/33 files (100%)
- ✅ **Usages replaced**: 3/32 files (~9%)
- ❌ **Remaining work**: 29 files, ~249 occurrences to update
- **Estimated effort**: 2-3 hours for remaining work (or use automation script)

## Automation Approach (Recommended)

Given the scale (249 occurrences), consider using a Python script to automate the replacements using regex and AST manipulation. The pattern is very repetitive and suitable for automation.
