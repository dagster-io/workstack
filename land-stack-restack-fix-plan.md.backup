---
erk_plan: true
session_id: b30e4f1b-f7f6-4d9e-93b7-92ee74782ef0
generated_at: 2025-11-21T13:59:47Z
---

# Fix land-stack Bug: Implement Restack Phase (TDD Style)

## Executive Summary

The `land-stack` command fails when landing stacked PRs because `_execute_restack_phase()` is a no-op function. After merging a PR with squash merge, upstack branches still reference old (now-squashed) commits, causing `gt submit` to fail with "merged commits are not contained in trunk". The fix involves implementing `_execute_restack_phase()` to call `ctx.graphite.sync(repo_root, force=True, quiet=not verbose)` to match the command's documented behavior. This must be done in TDD style: write failing tests first, then implement the fix.

**Critical Discovery:** Investigation revealed that the function is intentionally stubbed out with a comment saying "User should run 'gt sync -f' manually after landing if needed." However, this design is fundamentally broken because `gt submit` IS run automatically but fails without restacking first.

---

## Critical Context

### Root Cause Analysis (From Investigation)

**Location:** `src/erk/cli/commands/land_stack/execution.py:190-207`

The `_execute_restack_phase()` function is a complete no-op:

```python
def _execute_restack_phase(
    ctx: ErkContext,
    repo_root: Path,
    *,
    verbose: bool,
    script_mode: bool,
) -> None:
    """Execute restack phase using Graphite sync."""
    # Note: gt sync -f is NOT run automatically to prevent destructive rebasing.
    # User should run 'gt sync -f' manually after landing if needed.
    pass  # ← THIS DOES NOTHING!
```

**Why This Is Broken:**

The comment claims the command doesn't run `gt sync -f` automatically "to give users full control." But this is inconsistent with actual behavior:

- `gt submit` IS run automatically (line 247-249 in `_force_push_upstack_branches()`)
- `gt sync` is NOT run before it
- This creates a broken workflow where submission fails

**After Squash Merge Happens:**

1. ✅ PR #730 merges successfully (squashed into commit `d93ef893`)
2. ✅ Local master synced with `git fetch + git pull --ff-only`
3. ❌ MISSING: `gt sync` is never called to update Graphite metadata
4. ❌ MISSING: Upstack branches are never restacked onto new master
5. ❌ At line 249, `ctx.graphite.submit_branch()` is called for upstack branch
6. ❌ `gt submit` fails because:
   - Upstack branch still has old commit `6d3bc407` in its history
   - Master has new squashed commit `d93ef893`
   - Graphite detects commits aren't in trunk: "merged commits are not contained in the latest trunk branch master"

### Architectural Insights

**Design Decision Contradiction:**

The README.md states:
> **Manual Control:** The land-stack command does NOT automatically run `gt sync -f`. This gives you full control over when restacking and cleanup happen.

**But the actual workflow is:**
1. Merge PR (automatic)
2. ~~Restack upstack branches (manual)~~ ← SKIPPED!
3. Submit upstack branches (automatic) ← FAILS!

**The `--down` Flag Already Provides Manual Control:**

From `command.py:53`:
```python
@click.option(
    "--down",
    is_flag=True,
    help="Only land branches downstack (toward trunk) from current branch. Skips upstack rebase.",
)
```

Users who want manual control can use `--down` to skip restacking. The default behavior should work correctly.

### Why `force=True` Is Necessary

From Graphite's behavior after squash merges:

- Original branch commits (e.g., `6d3bc407`) are replaced with single squashed commit (e.g., `d93ef893`)
- Upstack branches still reference the old commits in their history
- `gt sync -f` (with force) rebases upstack branches onto the new squashed commit
- Without force, Graphite's metadata updates but branches aren't rebased
- `gt submit` requires rebased branches or it aborts with "merged commits are not contained in trunk"

**Therefore:** `ctx.graphite.sync(repo_root, force=True, quiet=not verbose)` is required.

### Test Infrastructure Available

**Fake Implementation:** `FakeGraphite` in `tests/fakes/graphite.py`

- ✅ Has `sync_calls` property: `list[tuple[Path, bool, bool]]` (repo_root, force, quiet)
- ✅ Can verify `force` and `quiet` parameters
- ✅ Already used in `test_sync.py` (lines 95-99, 130-133)

**Example from existing test:**
```python
assert len(graphite_ops.sync_calls) == 1
cwd_arg, force_arg, quiet_arg = graphite_ops.sync_calls[0]
assert force_arg is True
assert quiet_arg is False
```

**Test Location:** `tests/commands/graphite/land_stack/test_execution.py`

**Existing Test to Update:** `test_land_stack_does_not_run_gt_sync()` (lines 427-485)
- Currently asserts sync is NOT called: `assert len(graphite_ops.sync_calls) == 0`
- This test is now WRONG and must be updated to assert sync IS called

**Helper Fixture:** `erk_inmem_env(runner)`
- Provides `env.build_ops_from_branches()` to construct git/graphite ops
- Provides `env.build_context()` to create `ErkContext`
- Used in ALL test_execution.py tests

---

## Implementation Plan (TDD Style)

### Phase 1: Write Failing Tests (RED)

**1.1 Add test: `test_land_stack_runs_gt_sync_in_restack_phase()`**

Location: `tests/commands/graphite/land_stack/test_execution.py`

Purpose: Verify sync IS called during normal land-stack operation

Test structure:
```python
def test_land_stack_runs_gt_sync_in_restack_phase() -> None:
    """Verify gt sync -f runs automatically during restack phase."""
    runner = CliRunner()
    with erk_inmem_env(runner) as env:
        # Setup 2-branch stack
        git_ops, graphite_ops = env.build_ops_from_branches({
            "main": BranchMetadata.trunk("main", children=["feat-1"], commit_sha="abc123"),
            "feat-1": BranchMetadata.branch("feat-1", "main", children=["feat-2"], commit_sha="def456"),
            "feat-2": BranchMetadata.branch("feat-2", "feat-1", commit_sha="ghi789"),
        }, current_branch="feat-2")

        github_ops = FakeGitHub(pr_statuses={
            "feat-1": PRStatus(number=1, state="open", mergeable=True),
            "feat-2": PRStatus(number=2, state="open", mergeable=True),
        })

        test_ctx = env.build_context(
            git=git_ops,
            graphite=graphite_ops,
            github=github_ops,
            use_graphite=True,
        )

        # Act: Land the stack (without --down flag)
        result = runner.invoke(cli, ["land-stack", "--force"], obj=test_ctx)

        # Assert: Verify sync was called with force=True
        assert result.exit_code == 0
        assert len(graphite_ops.sync_calls) >= 1  # At least one sync call

        # Verify sync was called with correct parameters
        for repo_root_arg, force_arg, quiet_arg in graphite_ops.sync_calls:
            assert force_arg is True  # Must use force
            assert quiet_arg is False  # Default verbose mode
```

**1.2 Add test: `test_land_stack_skips_gt_sync_with_down_flag()`**

Purpose: Verify sync is NOT called when using `--down` flag

Test structure:
```python
def test_land_stack_skips_gt_sync_with_down_flag() -> None:
    """Verify gt sync is NOT called when using --down flag."""
    runner = CliRunner()
    with erk_inmem_env(runner) as env:
        # Setup 2-branch stack
        git_ops, graphite_ops = env.build_ops_from_branches({
            "main": BranchMetadata.trunk("main", children=["feat-1"], commit_sha="abc123"),
            "feat-1": BranchMetadata.branch("feat-1", "main", children=["feat-2"], commit_sha="def456"),
            "feat-2": BranchMetadata.branch("feat-2", "feat-1", commit_sha="ghi789"),
        }, current_branch="feat-2")

        github_ops = FakeGitHub(pr_statuses={
            "feat-1": PRStatus(number=1, state="open", mergeable=True),
        })

        test_ctx = env.build_context(
            git=git_ops,
            graphite=graphite_ops,
            github=github_ops,
            use_graphite=True,
        )

        # Act: Land with --down flag (skip restacking)
        result = runner.invoke(cli, ["land-stack", "--force", "--down"], obj=test_ctx)

        # Assert: Verify sync was NOT called
        assert result.exit_code == 0
        assert len(graphite_ops.sync_calls) == 0
```

**1.3 Add test: `test_land_stack_restack_respects_verbose_flag()`**

Purpose: Verify `quiet` parameter matches `not verbose`

Test structure:
```python
def test_land_stack_restack_respects_verbose_flag() -> None:
    """Verify quiet parameter is set correctly based on verbose flag."""
    runner = CliRunner()

    # Test 1: Without --verbose (default)
    with erk_inmem_env(runner) as env:
        git_ops, graphite_ops = env.build_ops_from_branches({...})
        test_ctx = env.build_context(git=git_ops, graphite=graphite_ops, use_graphite=True)

        result = runner.invoke(cli, ["land-stack", "--force"], obj=test_ctx)

        assert len(graphite_ops.sync_calls) >= 1
        _, _, quiet_arg = graphite_ops.sync_calls[0]
        assert quiet_arg is False  # Not verbose = quiet is False (show output)

    # Test 2: With --verbose
    with erk_inmem_env(runner) as env:
        git_ops, graphite_ops = env.build_ops_from_branches({...})
        test_ctx = env.build_context(git=git_ops, graphite=graphite_ops, use_graphite=True)

        result = runner.invoke(cli, ["land-stack", "--force", "--verbose"], obj=test_ctx)

        assert len(graphite_ops.sync_calls) >= 1
        _, _, quiet_arg = graphite_ops.sync_calls[0]
        assert quiet_arg is False  # Verbose = quiet is False (show MORE output)
```

**1.4 Update existing test: `test_land_stack_does_not_run_gt_sync()`**

Current state: Lines 427-485 in `test_execution.py`

Current assertion (WRONG):
```python
assert len(graphite_ops.sync_calls) == 0
```

Updated assertion (CORRECT):
```python
assert len(graphite_ops.sync_calls) == 1  # NOW it SHOULD be called
_, force_arg, _ = graphite_ops.sync_calls[0]
assert force_arg is True
```

Update docstring:
```python
def test_land_stack_does_not_run_gt_sync() -> None:
    """Verify gt sync IS run automatically during restack phase."""  # Updated
```

**1.5 Run tests - expect 3 new failures + 1 updated failure**

```bash
# Use devrun agent for pytest execution
Task(
    subagent_type="devrun",
    description="Run land-stack restack tests",
    prompt="Run pytest tests/commands/graphite/land_stack/test_execution.py::test_land_stack_runs_gt_sync_in_restack_phase -xvs"
)

Task(
    subagent_type="devrun",
    description="Run land-stack --down test",
    prompt="Run pytest tests/commands/graphite/land_stack/test_execution.py::test_land_stack_skips_gt_sync_with_down_flag -xvs"
)

Task(
    subagent_type="devrun",
    description="Run verbose flag test",
    prompt="Run pytest tests/commands/graphite/land_stack/test_execution.py::test_land_stack_restack_respects_verbose_flag -xvs"
)

Task(
    subagent_type="devrun",
    description="Run updated test",
    prompt="Run pytest tests/commands/graphite/land_stack/test_execution.py::test_land_stack_does_not_run_gt_sync -xvs"
)
```

Expected: All 4 tests fail (RED)

### Phase 2: Implement the Fix (GREEN)

**2.1 Implement `_execute_restack_phase()`**

Location: `src/erk/cli/commands/land_stack/execution.py:190-207`

Replace:
```python
def _execute_restack_phase(
    ctx: ErkContext,
    repo_root: Path,
    *,
    verbose: bool,
    script_mode: bool,
) -> None:
    """Execute restack phase using Graphite sync."""
    # Note: gt sync -f is NOT run automatically to prevent destructive rebasing.
    # User should run 'gt sync -f' manually after landing if needed.
    pass
```

With:
```python
def _execute_restack_phase(
    ctx: ErkContext,
    repo_root: Path,
    *,
    verbose: bool,
    script_mode: bool,
) -> None:
    """Execute restack phase using Graphite sync.

    Runs `gt sync -f` to:
    1. Update Graphite metadata about merged branches
    2. Rebase remaining upstack branches onto new trunk state

    This is necessary before submitting upstack branches, otherwise
    gt submit will fail with "merged commits are not contained in trunk".

    The --down flag can be used to skip restacking if manual control is desired.
    """
    ctx.graphite.sync(repo_root, force=True, quiet=not verbose)
```

**2.2 Run tests - expect all to pass (GREEN)**

```bash
Task(
    subagent_type="devrun",
    description="Run all land-stack tests",
    prompt="Run pytest tests/commands/graphite/land_stack/test_execution.py -xvs"
)
```

Expected: All tests pass

**2.3 Run full test suite**

```bash
Task(
    subagent_type="devrun",
    description="Run full test suite",
    prompt="Run pytest tests/ -x"
)
```

Expected: No regressions (all tests pass)

### Phase 3: Update Documentation (REFACTOR)

**3.1 Update command description (if needed)**

Location: `src/erk/cli/commands/land_stack/command.py:71-72`

Current (verify this is accurate):
```python
"""
Land branches sequentially from current branch (or specified branch above trunk) upward.
After each merge, it runs 'gt sync -f' to rebase upstack branches onto the updated trunk.
With --down, skips the rebase and branches that you don't want to rebase yet.
"""
```

This appears CORRECT already. Verify it matches actual behavior.

**3.2 Update README**

Location: `src/erk/cli/commands/land_stack/README.md:89-92`

Remove or revise:
```markdown
**Manual Control:** The land-stack command does NOT automatically run `gt sync -f`.
This gives you full control over when restacking and cleanup happen, allowing you to
inspect the state between operations.
```

Replace with:
```markdown
**Automatic Restacking:** The land-stack command runs `gt sync -f` automatically after
each merge to rebase upstack branches onto the updated trunk. This ensures upstack PRs
can be submitted successfully. Use `--down` flag to land only downstack branches and
skip automatic restacking.
```

**3.3 Update function docstring (already done in 2.1)**

Docstring was updated as part of implementation in Phase 2.1.

### Phase 4: Verify End-to-End

**4.1 Manual test: Reproduce original bug scenario**

Setup:
1. Create 2-branch stack locally
2. Create PRs for both branches
3. Run `erk land-stack`

Expected:
- ✅ First PR merges successfully
- ✅ `gt sync -f` runs automatically
- ✅ Second PR merges successfully
- ✅ No "merged commits not contained in trunk" error

**4.2 Run full CI**

```bash
Task(
    subagent_type="devrun",
    description="Run full CI",
    prompt="Run pytest tests/ && pyright src/ tests/ && ruff check src/ tests/"
)
```

Expected: All checks pass

---

## Testing Strategy

### Test Pattern (From Existing Tests)

```python
from click.testing import CliRunner
from tests.test_helpers import erk_inmem_env
from tests.fakes.graphite import FakeGraphite
from tests.fakes.github import FakeGitHub
from erk.core.branches import BranchMetadata, PRStatus

def test_land_stack_behavior() -> None:
    runner = CliRunner()
    with erk_inmem_env(runner) as env:
        # Build ops with branch structure
        git_ops, graphite_ops = env.build_ops_from_branches(
            {
                "main": BranchMetadata.trunk("main", children=["feat-1"]),
                "feat-1": BranchMetadata.branch("feat-1", "main"),
            },
            current_branch="feat-1",
        )

        github_ops = FakeGitHub(pr_statuses={
            "feat-1": PRStatus(number=1, state="open", mergeable=True),
        })

        test_ctx = env.build_context(
            git=git_ops,
            graphite=graphite_ops,
            github=github_ops,
            use_graphite=True,
        )

        # Execute command
        result = runner.invoke(cli, ["land-stack", "--force"], obj=test_ctx)

        # Verify mutations via read-only properties
        assert len(graphite_ops.sync_calls) == 1
        repo_root_arg, force_arg, quiet_arg = graphite_ops.sync_calls[0]
        assert force_arg is True
```

### Test Coverage Goals

1. ✅ Verify sync is called in normal flow
2. ✅ Verify sync is NOT called with --down flag
3. ✅ Verify force=True parameter
4. ✅ Verify quiet parameter respects verbose flag
5. ✅ Update existing test expectations

---

## Success Criteria

1. ✅ All new tests pass
2. ✅ Updated test passes
3. ✅ Full test suite passes (no regressions)
4. ✅ Documentation matches implementation
5. ✅ Manual verification: Can land 2-PR stack without error
6. ✅ Type checking passes (pyright)
7. ✅ Linting passes (ruff)

---

## Rollback Plan

If issues arise, the fix is a one-line change that's easy to revert:

- Revert `execution.py:207` from `ctx.graphite.sync(...)` back to `pass`
- Revert test changes

---

## Session Discoveries

### Discovery Journey

The investigation followed this path:

1. **Initial Error:** `land-stack` failed with Graphite error after merging first PR
2. **Diagnostic Commands:** Ran `git log`, `gt log short` to understand commit state
3. **Root Cause Found:** Identified `_execute_restack_phase()` is a no-op at line 190-207
4. **Searched for Context:** Looked for any restack/rebase logic in land_stack/ directory
5. **Found Inconsistency:** README says "NOT run automatically" but `gt submit` IS run automatically
6. **Discovered Graphite API:** Found `ctx.graphite.sync()` method exists with `force` parameter
7. **Located Test Infrastructure:** Found `FakeGraphite.sync_calls` mutation tracking
8. **Identified Fix Location:** Single function implementation needed

This discovery sequence revealed that:
- The function exists and is called, but does nothing
- The design decision (manual control) conflicts with actual behavior
- The `--down` flag already provides manual control option
- Fix is straightforward: one function implementation

### Failed Attempts Documented

**Considered Option 1: Run `gt sync` without `-f`**
- Effect: Updates metadata but doesn't rebase branches
- Rejected: Not sufficient, `gt submit` still fails without rebasing

**Considered Manual User Fix:**
- User runs `gt repo sync` and `gt stack restack` manually
- Rejected: Breaks automation, command should "just work"

**Considered Removing Automatic Submit:**
- Don't call `gt submit` automatically either
- Rejected: Inconsistent with command's purpose (land entire stack)

### Domain Knowledge

**Graphite Stack Terminology (Critical):**
- **UPSTACK** = away from trunk = toward TOP = toward leaves
- **DOWNSTACK** = toward trunk = toward BOTTOM = toward main

**After Squash Merge:**
- Original commits (e.g., `6d3bc407`) are replaced with single squashed commit (e.g., `d93ef893`)
- Upstack branches still have old commits in history
- `gt sync -f` rebases upstack branches onto new squashed commit
- Without rebase, `gt submit` detects mismatch and aborts

**The `--down` Flag:**
- Purpose: Land only downstack branches (toward trunk)
- Effect: Skips upstack rebase operations
- Provides manual control option for users who want it

### Technical Context

**Function Signature (Graphite ABC):**
```python
def sync(self, repo_root: Path, *, force: bool, quiet: bool) -> None:
    """Run gt sync to restack branches."""
```

**Parameters:**
- `repo_root`: Path to repository root
- `force`: If True, runs `gt sync -f` (rebase branches)
- `quiet`: If True, runs with `--quiet` flag (suppress output)

**FakeGraphite Mutation Tracking:**
```python
@property
def sync_calls(self) -> list[tuple[Path, bool, bool]]:
    """Returns list of (repo_root, force, quiet) tuples."""
```

**Test Helper:** `env.build_context()`
- Eliminates boilerplate GlobalConfig construction
- Accepts optional parameters: `git`, `graphite`, `github`, `use_graphite`, `dry_run`
- Provides sensible defaults for all parameters

---

## Risk Assessment

**Low Risk Implementation:**
- Single function change (1 line of code)
- Well-tested with comprehensive test coverage
- Existing `--down` flag provides escape hatch
- FakeGraphite already supports mutation tracking

**Potential Issues:**
- Users relying on broken behavior (unlikely, command currently fails)
- Performance impact of `gt sync -f` (acceptable, necessary for correctness)

**Mitigation:**
- Comprehensive test coverage (4 tests covering all scenarios)
- Documentation updates explaining behavior
- `--down` flag for users who need manual control
