# Implementation Plan: Migrate from `.PLAN.md` to `.plan/` folder structure

## Objective

Refactor the plan file system from a single `.PLAN.md` file to a `.plan/` folder containing:

- `plan.md` - Immutable implementation plan
- `progress.md` - Mutable progress tracking with step checkboxes

This separation eliminates the risk of corrupting the plan during progress updates and enables future extensibility.

## Architecture Decisions

- **No backward compatibility**: New worktrees use `.plan/`, old ones keep `.PLAN.md`
- **Progress format**: Pre-populated checkboxes for all steps, no timestamps
- **Minimal scope**: Just `plan.md` + `progress.md` for now
- **No migration tool**: Users manually migrate if needed
- **Utilities scope**: Only handle new `.plan/` format, no auto-detection of old format

## Context & Understanding

### Implementation Insights

**Current `.PLAN.md` Architecture:**

- Single file with immutable plan body + mutable Progress Tracking section
- `/workstack:implement-plan` must carefully parse and edit only the Progress section
- Risk of corruption if section boundaries are misidentified
- Located at `<worktree>/.PLAN.md`, always gitignored

**Status Display Integration:**

- Existing code: `src/workstack/status/collectors/plan.py` - Reads `.PLAN.md`, extracts summary
- Data model: `src/workstack/status/models/status_data.py` - `PlanStatus` dataclass
- Renderer: `src/workstack/status/renderers/simple.py` - Displays in `workstack status`

**Test Isolation Pattern:**

- All tests use `simulated_workstack_env()` helper from `tests/helpers/simulated_env.py`
- NEVER use hardcoded paths like `Path("/test/default/cwd")`
- Tests affected: `test_plan.py`, `test_create.py`, `test_plan_collector.py`

### API/Tool Quirks

**File Creation in `workstack create --plan`:**

- Located at: `src/workstack/cli/commands/create.py` lines 466-474
- Uses `shutil.move()` by default (removes source file)
- With `--keep-plan`: uses `shutil.copy2()` (preserves source)
- The plan file is moved AFTER worktree creation succeeds

**Filename Processing:**

- `strip_plan_from_filename()` in `src/workstack/core/naming_utils.py` (lines 91-180)
- Removes "plan" suffix intelligently: `my-feature-plan` → `my-feature`
- Then `sanitize_worktree_name()` enforces 30-char base limit
- Date suffix added after sanitization: `<base-30>-YY-MM-DD`

**Gitignore Timing:**

- `.PLAN.md` entry at line 20 of `.gitignore`
- New entry `.plan/` must be added
- Old repos won't have new pattern until they pull updates

### Known Pitfalls

**DO NOT edit plan.md after folder creation** - It's meant to be immutable reference material. Only update progress.md.

**DO NOT forget to update .gitignore** - Without `.plan/` entry, users might accidentally commit plans.

**DO NOT create circular dependencies** - `plan_folder.py` should not import from CLI commands; CLI imports from core utils.

**DO NOT use `Path.exists()` checks for both formats** - Since we're not supporting backward compat, only check `.plan/plan.md`.

**DO NOT forget to extract steps from plan.md** - The `create_plan_folder()` function must parse plan.md to populate progress.md checkboxes.

### Raw Discoveries Log

- Confirmed: User wants step references format (answer 4 from initial questions)
- Decided: No backward compatibility (user answer: "no backwards compat")
- Decided: Pre-populate all steps as checkboxes in progress.md
- Decided: Utilities only handle new format, no auto-detection
- Decided: Just checkbox status, no timestamps
- Verified: Current code uses single file at `<worktree>/.PLAN.md`
- Found: 13 test cases need updating (across 3 test files)
- Noted: `workstack create --plan` uses `--json --stay` flags
- Learned: Filename generation must respect 30-char base limit
- Discovered: Status collectors return `PlanStatus` dataclass with `exists`, `path`, `summary`, `line_count`, `first_lines` fields

### Planning Artifacts

**Files Examined During Planning:**

- `src/workstack/cli/commands/create.py` - Lines 251-475 (--plan flag handling)
- `src/workstack/core/naming_utils.py` - Lines 91-180 (filename stripping)
- `src/workstack/core/file_utils.py` - Lines 8-56 (title extraction)
- `src/workstack/status/collectors/plan.py` - Plan detection and summary
- `.claude/commands/workstack/implement-plan.md` - 244 lines (implementation command)
- `.gitignore` - Line 20 (current .PLAN.md entry)

**Key Patterns Observed:**

- Frozen dataclasses for immutability
- ABC-based interfaces (not Protocol)
- Absolute imports throughout
- LBYL exception handling (check before acting)
- `click.echo()` for all CLI output

### Implementation Risks

**Technical Complexity:**

- Parsing plan.md to extract numbered steps for progress.md checkboxes
- Handling nested steps (1.1, 1.2, 2.1) correctly
- Ensuring atomic folder creation (don't leave partial structure)

**Test Migration Effort:**

- Need to update 13+ test cases across 3 files
- Must ensure tests don't accidentally use old `.PLAN.md` paths
- Risk of false positives if tests check wrong location

**User Experience:**

- Old worktrees will silently stop showing plan info in `workstack status`
- Users with existing plans must manually migrate
- No warning when old format detected

## Implementation Steps

### Phase 1: Core Abstractions (Foundation)

**Goal:** Create reusable utilities for plan folder operations

**File:** `src/workstack/core/plan_folder.py` (NEW)

1. **Create `plan_folder.py` module** with these functions:
   - `create_plan_folder(worktree_path: Path, plan_content: str) -> Path`
     - Creates `.plan/` directory
     - Writes `plan.md` with plan_content
     - Parses plan_content to extract all numbered steps
     - Generates `progress.md` with pre-populated checkboxes for all steps
     - Returns `.plan/` path
     - Raises `FileExistsError` if `.plan/` already exists
     - [CRITICAL: Use encoding="utf-8" for all file operations]

   Related Context:
   - User decision: Pre-populate all steps as checkboxes (not empty file)
   - Must handle nested steps: "1.1", "1.2", "2.1" etc.
   - See Known Pitfalls for immutability requirement

   - `get_plan_path(worktree_path: Path) -> Path | None`
     - Checks for `.plan/plan.md`
     - Returns path if exists, None otherwise
     - [CRITICAL: Do NOT check for old `.PLAN.md` format - no backward compat]

   Related Context:
   - User decision: Only handle new .plan/ format
   - Status collectors will use this to detect plans

   - `get_progress_path(worktree_path: Path) -> Path | None`
     - Checks for `.plan/progress.md`
     - Returns path if exists, None otherwise

   - `update_progress(worktree_path: Path, progress_content: str) -> None`
     - Writes to `.plan/progress.md`
     - Creates file if doesn't exist
     - [CRITICAL: Use encoding="utf-8"]

   Related Context:
   - Used by `/workstack:implement-plan` to update checkboxes
   - Simple write operation, no parsing needed

   - `extract_steps_from_plan(plan_content: str) -> list[str]`
     - Parses plan markdown for numbered steps
     - Returns list of step descriptions
     - Handles nested numbering (1.1, 1.2, etc.)
     - Used internally by `create_plan_folder()`

   Related Context:
   - Must handle various formats: "1.", "1)", "Step 1:", etc.
   - See Raw Discoveries for step format observations

   **Success:** All functions implemented and pass unit tests over fake filesystem

2. **Update `src/workstack/core/file_utils.py`**:
   - Add `extract_plan_title_from_folder(folder_path: Path) -> str | None`
     - Reads `plan.md` from folder
     - Delegates to existing `extract_plan_title()` logic
     - Returns None if folder or file doesn't exist

   Related Context:
   - Reuses existing title extraction logic from line 8-56
   - Used by status display to show plan titles

   **Success:** Function works with `.plan/` folders, existing tests still pass

**Testing:**

- Create `tests/core/test_plan_folder.py` with coverage for all new functions
- Test edge cases: empty plans, malformed steps, special characters
- Use `tmp_path` fixture for file operations

### Phase 2: CLI Integration (Create Command)

**Goal:** Update `workstack create --plan` to use new folder structure

**File:** `src/workstack/cli/commands/create.py`

1. **Update plan file handling** (lines 466-474):

   Replace current file move logic with:

   ```python
   from workstack.core.plan_folder import create_plan_folder

   # Read plan content from source file
   plan_content = plan_file_path.read_text(encoding="utf-8")

   # Create .plan/ folder in new worktree
   plan_folder_path = create_plan_folder(worktree_path, plan_content)

   # Handle --keep-plan flag
   if not keep_plan_flag:
       plan_file_path.unlink()  # Remove source file
   ```

   [CRITICAL: Ensure folder creation happens AFTER worktree creation succeeds, before removing source file]

   Related Context:
   - See API/Tool Quirks for current file move behavior
   - Must maintain `--keep-plan` flag functionality
   - Original uses `shutil.move()` at line 466-474

2. **Update success messages**:

   Change: `"Plan file moved to .PLAN.md"`
   To: `"Plan created at .plan/"`

   Related Context:
   - User sees this message in terminal output
   - Update anywhere `.PLAN.md` is mentioned in user-facing messages

3. **Update JSON output** (if applicable):

   Change `plan_file` field from `.PLAN.md` path to `.plan/` path

   Related Context:
   - JSON output used by `/workstack:create-planned-stack` command
   - Must return folder path, not plan.md file path

**Testing:**

- Update `tests/commands/workspace/test_create.py` (lines 17-100)
- Change assertions from `.PLAN.md` to `.plan/plan.md` and `.plan/progress.md`
- Test `--keep-plan` flag behavior
- Test JSON output format

**Success:** `workstack create --plan file.md` creates `.plan/` folder with both files

### Phase 3: Status Display Updates

**Goal:** Make `workstack status` read from new structure

**File:** `src/workstack/status/collectors/plan.py`

1. **Update plan detection**:
   - Import `get_plan_path` from `workstack.core.plan_folder`
   - Replace `.PLAN.md` check with `get_plan_path(worktree_path)`
   - Read from `.plan/plan.md` for summary
   - Read from `.plan/progress.md` for progress info (if exists)

   [CRITICAL: Only check for new format - old `.PLAN.md` files will be ignored]

   Related Context:
   - User decision: No backward compatibility
   - Old worktrees will show no plan in status display

2. **Extract progress percentage**:
   - Count checked vs unchecked boxes in progress.md
   - Format: "X/Y steps completed"
   - Handle missing progress.md gracefully

   Related Context:
   - Progress format: `- [x]` (completed) or `- [ ]` (pending)
   - Simple regex or string counting

**File:** `src/workstack/status/models/status_data.py`

3. **Update `PlanStatus` dataclass**:

   Add fields:

   ```python
   progress_summary: str | None  # e.g., "3/10 steps completed"
   format: Literal["folder", "none"]  # Removed "file" since no backward compat
   ```

   Related Context:
   - Frozen dataclass pattern (immutable)
   - Use `str | None` not `Optional[str]`

**File:** `src/workstack/status/renderers/simple.py`

4. **Update status display**:
   - Show progress summary if available
   - Format: "Plan: [title] (3/10 steps completed)"

   Related Context:
   - Use `click.style()` for colors (see AGENTS.md CLI Output Styling)
   - Plan titles: `bright_magenta`, Progress: `green`

**Testing:**

- Update `tests/status/collectors/test_plan_collector.py`
- Add tests for progress percentage calculation
- Test missing progress.md case
- Verify old `.PLAN.md` files are ignored

**Success:** `workstack status` shows plan info with progress for new format

### Phase 4: Slash Command Updates

**Goal:** Update automation to use new structure

**File:** `.claude/commands/workstack/implement-plan.md`

1. **Update plan detection** (beginning of command):

   Change from:

   ```markdown
   1. Verifies `.PLAN.md` exists in current directory
   ```

   To:

   ```markdown
   1. Verifies `.plan/plan.md` exists in current directory
   2. If not found, show error: "No plan folder found. Expected .plan/plan.md"
   ```

   [CRITICAL: Do NOT fallback to `.PLAN.md` - new format only]

2. **Simplify progress updates** (middle of command):

   Remove: Complex section parsing logic

   Add: Direct write to `.plan/progress.md`

   ```markdown
   After completing each step, update progress.md by:

   1. Read current progress.md content
   2. Replace `- [ ] Step X` with `- [x] Step X`
   3. Write updated content back to progress.md
   ```

   Related Context:
   - No more risk of corrupting plan body
   - Simple find-replace operation
   - Use `update_progress()` if calling from Python code

3. **Update instructions** (throughout):
   - Change all references from `.PLAN.md` to `.plan/`
   - Clarify that plan.md is immutable, only progress.md changes
   - Document the checkbox format: `- [x]` and `- [ ]`

**File:** `.claude/commands/workstack/create-planned-stack.md`

4. **Update documentation**:
   - Change references from "saves plan to `.PLAN.md`" to "creates `.plan/` folder"
   - Update success criteria to mention both `plan.md` and `progress.md`
   - Document pre-populated progress.md behavior

**Testing:**

- Manual testing: Create plan, run `/workstack:implement-plan`, verify progress updates
- Ensure old `.PLAN.md` worktrees trigger appropriate error

**Success:** `/workstack:implement-plan` works with new structure, updates only progress.md

### Phase 5: Configuration & Documentation

**Goal:** Update gitignore and documentation

**File:** `.gitignore`

1. **Add new gitignore entry** (after line 20):

   ```gitignore
   # Agent-tracked implementation plans (local-only)
   .PLAN.md  # Legacy format (keep for old worktrees)
   .plan/    # New folder-based format
   ```

   Related Context:
   - Keep `.PLAN.md` entry for old worktrees
   - See API/Tool Quirks for gitignore timing

**File:** `docs/agent/glossary.md`

2. **Update plan file definition** (lines 309-330):
   - Change from "`.PLAN.md` file" to "`.plan/` folder"
   - Document folder structure: `plan.md` (immutable) + `progress.md` (mutable)
   - Explain separation of concerns benefit
   - Note: Old worktrees may still use `.PLAN.md`

**File:** `AGENTS.md`

3. **Update line 14 comment**:

   Change:

   ```markdown
   **NOTE: `.PLAN.md` files are NOT tracked in git and should never be committed**
   ```

   To:

   ```markdown
   **NOTE: `.plan/` folders are NOT tracked in git and should never be committed**
   ```

**File:** `README.md`

4. **Update plan file references** (lines 62-64):
   - Change mentions of `.PLAN.md` to `.plan/`
   - Update example command outputs if shown

**File:** `.claude/skills/workstack/references/workstack.md`

5. **Update skill documentation**:
   - Document new folder format
   - Update examples to show `.plan/` instead of `.PLAN.md`

**Success:** All documentation references new structure, gitignore updated

### Phase 6: Test Updates

**Goal:** Update all test fixtures and assertions

**Files:** Test suite

1. **Update `tests/commands/management/test_plan.py`**:
   - Change assertions from `.PLAN.md` to `.plan/plan.md` and `.plan/progress.md`
   - Add assertion to verify both files exist
   - Check progress.md has pre-populated checkboxes

2. **Update `tests/commands/workspace/test_create.py`** (lines 17-100):
   - Update `test_create_with_plan_file()`:
     - Assert `.plan/` folder exists
     - Assert `.plan/plan.md` contains original plan content
     - Assert `.plan/progress.md` exists with checkboxes
     - Verify source file deleted (unless `--keep-plan`)

   - Update `test_create_with_plan_name_sanitization()`:
     - No changes needed (works at filename level)

3. **Update `tests/status/collectors/test_plan_collector.py`**:
   - Create `.plan/` folders instead of `.PLAN.md` files in fixtures
   - Test progress percentage calculation
   - Test missing progress.md case
   - Verify `format` field is "folder"

4. **Add new test cases**:
   - Test `create_plan_folder()` with various plan formats
   - Test step extraction with nested numbering
   - Test atomic folder creation (cleanup on failure)
   - Test empty or malformed plans

**Testing Strategy:**

- Use `simulated_workstack_env()` helper
- Use `tmp_path` fixture for file operations
- No hardcoded paths

**Success:** All tests pass, coverage maintained or improved

---

## Progress Tracking

**Current Status:** Not Started
**Last Updated:** 2025-11-14

### Phase 1: Core Abstractions

**Status:** ⏸️ NOT STARTED

- [ ] Create `src/workstack/core/plan_folder.py` with `create_plan_folder()`
- [ ] Implement `get_plan_path()` function
- [ ] Implement `get_progress_path()` function
- [ ] Implement `update_progress()` function
- [ ] Implement `extract_steps_from_plan()` helper
- [ ] Update `src/workstack/core/file_utils.py` with `extract_plan_title_from_folder()`
- [ ] Create `tests/core/test_plan_folder.py` with full coverage
- [ ] Verify all Phase 1 tests pass

### Phase 2: CLI Integration

**Status:** ⏸️ NOT STARTED

- [ ] Update `src/workstack/cli/commands/create.py` lines 466-474 to use `create_plan_folder()`
- [ ] Handle `--keep-plan` flag correctly
- [ ] Update success messages to reference `.plan/`
- [ ] Update JSON output `plan_file` field
- [ ] Update `tests/commands/workspace/test_create.py` assertions
- [ ] Test `--keep-plan` flag behavior
- [ ] Test JSON output format
- [ ] Verify all Phase 2 tests pass

### Phase 3: Status Display

**Status:** ⏸️ NOT STARTED

- [ ] Update `src/workstack/status/collectors/plan.py` to use `get_plan_path()`
- [ ] Add progress percentage calculation
- [ ] Update `src/workstack/status/models/status_data.py` with new fields
- [ ] Update `src/workstack/status/renderers/simple.py` to show progress
- [ ] Update `tests/status/collectors/test_plan_collector.py`
- [ ] Add tests for progress percentage calculation
- [ ] Test missing progress.md case
- [ ] Verify all Phase 3 tests pass

### Phase 4: Slash Commands

**Status:** ⏸️ NOT STARTED

- [ ] Update `.claude/commands/workstack/implement-plan.md` plan detection
- [ ] Simplify progress update logic in implement-plan command
- [ ] Update all `.PLAN.md` references to `.plan/`
- [ ] Update `.claude/commands/workstack/create-planned-stack.md` documentation
- [ ] Manual test: Create plan and run `/workstack:implement-plan`
- [ ] Verify progress updates work correctly

### Phase 5: Configuration & Documentation

**Status:** ⏸️ NOT STARTED

- [ ] Add `.plan/` entry to `.gitignore` (keep `.PLAN.md` too)
- [ ] Update `docs/agent/glossary.md` lines 309-330
- [ ] Update `AGENTS.md` line 14 comment
- [ ] Update `README.md` lines 62-64
- [ ] Update `.claude/skills/workstack/references/workstack.md`
- [ ] Verify all documentation is consistent

### Phase 6: Tests

**Status:** ⏸️ NOT STARTED

- [ ] Update `tests/commands/management/test_plan.py`
- [ ] Update `tests/commands/workspace/test_create.py` lines 17-100
- [ ] Update `tests/status/collectors/test_plan_collector.py`
- [ ] Add new test cases for edge cases
- [ ] Run full test suite with `uv run pytest`
- [ ] Verify coverage maintained or improved
- [ ] Run `make all-ci` to ensure all checks pass

### Overall Progress

**Phases Complete:** 0 / 6
**Total Steps:** 0 / 52
